"""Export baseline_summary.csv for RAG baseline comparison figure.

This script bridges Exp23 (exp2to4_lite) results and the paper's
`fig_r_baseline_comparison.py` script by converting the latest
`exp23_summary_*.csv` into `data/rag_eval/baseline_summary.csv`.

Input:
  - experiments/exp2to4_lite/results/exp23_summary_*.csv
    (generated by `experiments.exp2to4_lite.run_exp23`)

Output:
  - data/rag_eval/baseline_summary.csv with columns:
      method, acceptance, FMR, latency_ms
"""

from __future__ import annotations

from pathlib import Path
import csv
from typing import List, Dict


def _latest_summary(results_dir: Path) -> Path | None:
    files = sorted(results_dir.glob("exp23_summary_*.csv"))
    return files[-1] if files else None


def _load_rows(csv_path: Path) -> List[Dict[str, str]]:
    rows: List[Dict[str, str]] = []
    with csv_path.open("r", encoding="utf-8") as fh:
        reader = csv.DictReader(fh)
        for r in reader:
            rows.append(r)
    return rows


def _friendly_method(baseline_name: str) -> str:
    mapping = {
        "static_rag": "Static",
        "frequency": "Frequency",
        "cosine_topk": "Cosine",
        "gedig_ag_dg": "geDIG-lite",
    }
    return mapping.get(baseline_name, baseline_name)


def export_baseline_csv(results_dir: Path, out_path: Path) -> None:
    summary = _latest_summary(results_dir)
    if summary is None:
        raise SystemExit(f"No exp23_summary_*.csv found under {results_dir}")

    rows = _load_rows(summary)
    # Expected columns in summary CSV
    # baseline, per_mean, acceptance_rate, zsr, fmr, latency_p50, latency_p95, ...
    out_path.parent.mkdir(parents=True, exist_ok=True)
    with out_path.open("w", encoding="utf-8", newline="") as fh:
        writer = csv.writer(fh)
        writer.writerow(["method", "acceptance", "FMR", "latency_ms"])
        for r in rows:
            name = str(r.get("baseline", ""))
            method = _friendly_method(name)
            try:
                acc = float(r.get("acceptance_rate", 0.0))
                fmr = float(r.get("fmr", 0.0))
                lat = float(r.get("latency_p50", 0.0))
            except Exception:
                acc, fmr, lat = 0.0, 0.0, 0.0
            writer.writerow([method, f"{acc:.4f}", f"{fmr:.4f}", f"{lat:.1f}"])


def main() -> None:
    repo_root = Path(__file__).resolve().parents[3]
    results_dir = repo_root / "experiments" / "exp2to4_lite" / "results"
    out_path = repo_root / "data" / "rag_eval" / "baseline_summary.csv"
    export_baseline_csv(results_dir, out_path)
    print(f"âœ… Wrote {out_path}")


if __name__ == "__main__":
    main()

